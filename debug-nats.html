<!DOCTYPE html>
<html>
<head>
    <title>Debug NATS WebSocket</title>
</head>
<body>
    <h1>NATS WebSocket Debug</h1>
    <button onclick="testWebSocket()">Test Raw WebSocket</button>
    <button onclick="testNatsProtocol()">Test NATS Protocol</button>
    <pre id="output"></pre>
    
    <script>
    const output = document.getElementById('output');
    
    function log(msg) {
        const timestamp = new Date().toISOString();
        output.textContent += `[${timestamp}] ${msg}\n`;
        console.log(msg);
    }
    
    function testWebSocket() {
        log('Testing raw WebSocket connection to ws://localhost:8081...');
        
        const ws = new WebSocket('ws://localhost:8081');
        
        ws.onopen = () => {
            log('‚úÖ WebSocket connected!');
            log('Sending NATS CONNECT message...');
            ws.send('CONNECT {"verbose":false,"pedantic":false,"tls_required":false,"name":"debug-client"}\r\n');
        };
        
        ws.onmessage = (event) => {
            log('üì• Received: ' + event.data);
        };
        
        ws.onerror = (error) => {
            log('‚ùå WebSocket error: ' + error);
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = (event) => {
            log(`üîå WebSocket closed: code=${event.code}, reason=${event.reason}`);
        };
    }
    
    async function testNatsProtocol() {
        log('Testing NATS protocol...');
        
        try {
            const ws = new WebSocket('ws://localhost:8081');
            
            await new Promise((resolve, reject) => {
                ws.onopen = resolve;
                ws.onerror = reject;
                setTimeout(() => reject(new Error('Connection timeout')), 5000);
            });
            
            log('‚úÖ Connected, sending CONNECT...');
            ws.send('CONNECT {"verbose":false,"pedantic":false}\r\n');
            
            // Wait for response
            await new Promise(resolve => {
                ws.onmessage = (event) => {
                    log('Response: ' + event.data);
                    resolve();
                };
            });
            
            // Subscribe
            log('Subscribing to meme.response...');
            ws.send('SUB meme.response 1\r\n');
            
            // Publish test message
            const testMsg = JSON.stringify({
                id: 'test-' + Date.now(),
                prompt: 'debugging test',
                fast_mode: true,
                small_image: true
            });
            
            log('Publishing test message...');
            ws.send(`PUB meme.request ${testMsg.length}\r\n${testMsg}\r\n`);
            
            // Listen for more messages
            ws.onmessage = (event) => {
                log('üì• Message: ' + event.data);
            };
            
        } catch (error) {
            log('‚ùå Error: ' + error);
        }
    }
    </script>
</body>
</html>