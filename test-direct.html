<!DOCTYPE html>
<html>
<head>
    <title>Direct NATS Test</title>
</head>
<body>
    <h1>Direct NATS WebSocket Test</h1>
    <button onclick="testDirect()">Send Direct Test</button>
    <pre id="output"></pre>
    
    <script>
    const output = document.getElementById('output');
    
    function log(msg) {
        const timestamp = new Date().toISOString();
        const line = `[${timestamp}] ${msg}\n`;
        output.textContent += line;
        console.log(msg);
    }
    
    async function testDirect() {
        log('Creating WebSocket connection...');
        
        const ws = new WebSocket('ws://localhost:8081');
        
        ws.onopen = () => {
            log('WebSocket opened, sending CONNECT...');
            // Send CONNECT
            ws.send('CONNECT {"verbose":true,"pedantic":false}\r\n');
        };
        
        let messageCount = 0;
        ws.onmessage = (event) => {
            messageCount++;
            log(`Message #${messageCount}: ${event.data.trim()}`);
            
            if (event.data.includes('+OK') && messageCount === 1) {
                log('Got +OK, subscribing to response subjects...');
                ws.send('SUB meme.response 1\r\n');
                ws.send('SUB meme.response.error 2\r\n');
                
                setTimeout(() => {
                    const testMsg = {
                        id: 'direct-test-' + Date.now(),
                        prompt: 'a cat debugging code',
                        fast_mode: true,
                        small_image: true
                    };
                    
                    const msgJson = JSON.stringify(testMsg);
                    const pubCmd = `PUB meme.request ${msgJson.length}\r\n${msgJson}\r\n`;
                    
                    log('Publishing message: ' + msgJson);
                    log('Command: ' + pubCmd.replace(/\r\n/g, '\\r\\n'));
                    
                    ws.send(pubCmd);
                    log('Message sent!');
                }, 500);
            }
        };
        
        ws.onerror = (error) => {
            log('WebSocket error: ' + JSON.stringify(error));
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = (event) => {
            log(`WebSocket closed: code=${event.code}, reason=${event.reason}`);
        };
    }
    </script>
</body>
</html>