<!DOCTYPE html>
<html>
<head>
    <title>Test WebSocket through Ingress</title>
</head>
<body>
    <h1>WebSocket through Ingress Test</h1>
    <p>Make sure you've added to /etc/hosts: <code>192.168.49.2 nats.meme-generator.local</code></p>
    <button onclick="testIngress()">Test via Ingress</button>
    <button onclick="testDirect()">Test via Port Forward</button>
    <pre id="output"></pre>
    
    <script>
    const output = document.getElementById('output');
    
    function log(msg) {
        const timestamp = new Date().toISOString();
        output.textContent += `[${timestamp}] ${msg}\n`;
        console.log(msg);
    }
    
    async function testConnection(url, label) {
        log(`\n=== Testing ${label} ===`);
        log(`Connecting to ${url}...`);
        
        try {
            const ws = new WebSocket(url);
            
            ws.onopen = () => {
                log('✅ WebSocket connected!');
                log('Sending CONNECT...');
                ws.send('CONNECT {"verbose":false,"pedantic":false}\r\n');
            };
            
            let messageNum = 0;
            ws.onmessage = (event) => {
                messageNum++;
                log(`Message #${messageNum}: ${event.data.trim()}`);
                
                if (messageNum === 1 && event.data.includes('+OK')) {
                    log('Subscribing and publishing test message...');
                    ws.send('SUB meme.response 1\r\n');
                    
                    const msg = {
                        id: `${label}-${Date.now()}`,
                        prompt: 'cats debugging',
                        fast_mode: true,
                        small_image: true
                    };
                    const json = JSON.stringify(msg);
                    ws.send(`PUB meme.request ${json.length}\r\n${json}\r\n`);
                    log('Published: ' + json);
                }
            };
            
            ws.onerror = (error) => {
                log('❌ Error: ' + error);
            };
            
            ws.onclose = (event) => {
                log(`Connection closed: ${event.code} - ${event.reason}`);
            };
            
        } catch (error) {
            log('❌ Exception: ' + error);
        }
    }
    
    function testIngress() {
        // Test through ingress (requires hosts file entry)
        testConnection('ws://nats.meme-generator.local', 'Ingress');
    }
    
    function testDirect() {
        // Test through port forward
        testConnection('ws://localhost:8081', 'Port-Forward');
    }
    </script>
</body>
</html>