<!DOCTYPE html>
<html>
<head>
    <title>NATS Connection Test</title>
</head>
<body>
    <h1>NATS WebSocket Test</h1>
    <button onclick="testConnection()">Test NATS Connection</button>
    <button onclick="sendTestMessage()">Send Test Message</button>
    <pre id="output"></pre>
    
    <script type="module">
    import { connect, JSONCodec } from 'https://unpkg.com/nats.ws@1.29.5/esm/nats.js';
    
    let nc = null;
    const jc = JSONCodec();
    const output = document.getElementById('output');
    
    function log(msg) {
        output.textContent += msg + '\n';
        console.log(msg);
    }
    
    window.testConnection = async function() {
        try {
            log('Connecting to ws://localhost:8081...');
            nc = await connect({ 
                servers: 'ws://localhost:8081',
                verbose: true,
                debug: true
            });
            log('✅ Connected successfully!');
            
            // Subscribe to responses
            const sub = nc.subscribe('meme.response');
            log('Subscribed to meme.response');
            
            (async () => {
                for await (const m of sub) {
                    const response = jc.decode(m.data);
                    log('Response received: ' + JSON.stringify(response));
                }
            })();
            
        } catch (err) {
            log('❌ Connection error: ' + err);
        }
    }
    
    window.sendTestMessage = async function() {
        if (!nc) {
            log('Not connected! Click Test Connection first.');
            return;
        }
        
        const msg = {
            id: 'test-' + Date.now(),
            prompt: 'cats playing chess',
            fast_mode: true,
            small_image: true
        };
        
        log('Publishing to meme.request: ' + JSON.stringify(msg));
        try {
            nc.publish('meme.request', jc.encode(msg));
            log('✅ Message published!');
        } catch (err) {
            log('❌ Publish error: ' + err);
        }
    }
    </script>
</body>
</html>